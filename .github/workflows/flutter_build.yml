name: Flutter CI and Release

on:
  pull_request:
    paths:
      - 'flutter_app/**'
      - 'rust_core/**'
      - '.github/workflows/flutter_build.yml'
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter_app
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Flutter
        uses: subosito/flutter-action@v2 # v2.16.0
        with:
          flutter-version: '3.22.3'
          channel: stable
          cache: true

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Static analysis
        run: flutter analyze

      - name: Unit tests
        run: flutter test

  build-android:
    name: Build Android Release APK
    runs-on: ubuntu-latest
    needs: validate
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    env:
      CARGO_TERM_COLOR: always
      NDK_VERSION: 26.3.11579264
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Java
        uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4.3.0
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Setup Android SDK + NDK
        uses: android-actions/setup-android@2f2f78f6ff77a09a721dd4f79f2dcdcb8112f58a # v3.2.2
      - name: Install Android NDK
        run: sdkmanager "ndk;${NDK_VERSION}"

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@9b327e4d31a0848fbf094892961691f4f08d6838 # master
        with:
          toolchain: stable
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@aef919558f29a0cbff16f963584e4104cb4f8bd1 # v2.7.3
        with:
          workspaces: rust_core

      - name: Install cargo-ndk
        run: cargo install --locked cargo-ndk --version 3.5.4

      - name: Build Rust Android libraries
        working-directory: rust_core
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.NDK_VERSION }}
        run: |
          cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 \
            -o ../flutter_app/android/app/src/main/jniLibs build --release

      - name: Setup Flutter
        uses: subosito/flutter-action@v2 # v2.16.0
        with:
          flutter-version: '3.22.3'
          channel: stable
          cache: true

      - name: Install Flutter dependencies
        working-directory: flutter_app
        run: flutter pub get

      - name: Build APK
        working-directory: flutter_app
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: reddmobile-release-apk
          path: flutter_app/build/app/outputs/flutter-apk/app-release.apk

      - name: Publish GitHub release
        uses: softprops/action-gh-release@8c5df2f5605f088f6f4133148da18b9946be4c9f # v2.0.8
        with:
          files: flutter_app/build/app/outputs/flutter-apk/app-release.apk
          name: ReddMobile ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
